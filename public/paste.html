<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luma Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: ui-monospace, "JetBrains Mono", monospace;
      background: #07070a;
      color: #fff;
    }
    .step-active {
      background: linear-gradient(90deg, #6d28d9, #a78bfa);
      color: white;
    }
    .step-inactive {
      background: rgba(255, 255, 255, 0.1);
      color: #cbd5e1;
    }
    .glass {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl space-y-6">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold text-purple-300">Luma Builder</h1>
      <div id="uses-box" class="text-sm text-neutral-300">
        Usos restantes: <span id="uses-left">‚Äî</span>
      </div>
    </div>

    <div class="glass p-6 rounded-2xl shadow-xl">
      <!-- Stepper -->
      <div class="flex items-center gap-3 mb-6">
        <div id="step-1" class="px-3 py-2 rounded-md step-active">1. Modo</div>
        <div class="h-0.5 bg-white/5 flex-1"></div>
        <div id="step-2" class="px-3 py-2 rounded-md step-inactive">2. Dados</div>
        <div class="h-0.5 bg-white/5 flex-1"></div>
        <div id="step-3" class="px-3 py-2 rounded-md step-inactive">3. Gerar</div>
      </div>

      <!-- Step 1: Modo -->
      <div id="pane-1">
        <p class="text-sm text-neutral-300 mb-4">Escolha o modo (obrigat√≥rio):</p>
        <div class="flex gap-3">
          <button id="mode-roblox" class="flex-1 px-4 py-3 rounded-full bg-neutral-800 hover:bg-neutral-700">Roblox</button>
          <button id="mode-platform" class="flex-1 px-4 py-3 rounded-full bg-neutral-800 hover:bg-neutral-700">Plataformas</button>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button id="to-step-2" class="px-4 py-2 rounded bg-purple-600 hover:bg-purple-500">Pr√≥ximo</button>
        </div>
      </div>

      <!-- Step 2: Dados -->
      <div id="pane-2" class="hidden">
        <!-- Roblox -->
        <div id="roblox-pane" class="hidden space-y-3">
          <label class="text-sm text-neutral-300">Link privado do Roblox (obrigat√≥rio)</label>
          <input id="roblox-link" type="text"
                 placeholder="https://www.roblox.com/share?code=..."
                 class="w-full p-3 rounded bg-neutral-900 border border-neutral-800" />
        </div>

        <!-- Plataformas -->
        <div id="platform-pane" class="hidden space-y-3">
          <label class="text-sm text-neutral-300">Plataforma (obrigat√≥rio)</label>
          <select id="platform-select"
                  class="w-full p-3 rounded bg-neutral-900 border border-neutral-800">
            <option value="">-- Escolha --</option>
            <option value="YouTube">YouTube</option>
            <option value="Tiktok">Tiktok</option>
            <option value="Spotify">Spotify</option>
            <option value="RobloxProfile">Roblox - Perfil</option>
          </select>

          <div class="space-y-3">
            <label class="text-sm text-neutral-300">Nome de usu√°rio (obrigat√≥rio)</label>
            <input id="platform-username" type="text"
                   placeholder="nomeDeUsuario"
                   class="w-full p-3 rounded bg-neutral-900 border border-neutral-800" />

            <label class="text-sm text-neutral-300">Link privado (obrigat√≥rio)</label>
            <input id="platform-link" type="text"
                   placeholder="https://..."
                   class="w-full p-3 rounded bg-neutral-900 border border-neutral-800" />
          </div>
        </div>

        <div class="mt-6 flex justify-between">
          <button id="back-step-1"
                  class="px-4 py-2 rounded bg-neutral-700 hover:bg-neutral-600">Voltar</button>
          <button id="to-step-3"
                  class="px-4 py-2 rounded bg-purple-600 hover:bg-purple-500">Pr√≥ximo</button>
        </div>
      </div>

      <!-- Step 3: Gerar -->
      <div id="pane-3" class="hidden">
        <div id="summary" class="space-y-3 text-sm text-neutral-300"></div>

        <div class="mt-4 flex gap-3">
          <button id="start-generate" class="px-4 py-3 rounded bg-green-600 hover:bg-green-500 flex-1">Gerar Builder</button>
          <button id="copy-output" class="px-4 py-3 rounded bg-purple-600 hover:bg-purple-500 hidden">Copiar</button>
        </div>

        <div id="output-area" class="mt-4 p-3 rounded bg-neutral-900 border border-neutral-800 hidden">
          <label class="text-xs text-neutral-400">Link gerado:</label>
          <input id="generated-output" readonly class="w-full mt-2 p-2 bg-transparent outline-none text-sm" />
        </div>

        <div class="mt-6 flex justify-between">
          <button id="back-step-2" class="px-4 py-2 rounded bg-neutral-700 hover:bg-neutral-600">Voltar</button>
          <button id="reset-all" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500">Resetar</button>
        </div>
      </div>

      <div id="error-box" class="mt-4 text-sm text-red-400 hidden"></div>
    </div>
  </div>

<script>
(async function(){
  // üîê Prote√ß√£o de login
  try {
    const r = await fetch('/api/user', { credentials: 'include' });
    if (!r.ok) return window.location.href = '/';
    const { user } = await r.json();
    if (!user) return window.location.href = '/';
  } catch(e){ window.location.href = '/'; }

  // Stepper logic
  const stepEls = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
  const pane1 = document.getElementById('pane-1');
  const pane2 = document.getElementById('pane-2');
  const pane3 = document.getElementById('pane-3');
  const errorBox = document.getElementById('error-box');
  const usesLeftEl = document.getElementById('uses-left');

  const modeRobloxBtn = document.getElementById('mode-roblox');
  const modePlatformBtn = document.getElementById('mode-platform');
  const robloxPane = document.getElementById('roblox-pane');
  const platformPane = document.getElementById('platform-pane');
  const platformSelect = document.getElementById('platform-select');

  let mode = null;

  function setStep(n){
    stepEls.forEach((el,i)=> el.className = (i+1===n ? "px-3 py-2 rounded-md step-active" : "px-3 py-2 rounded-md step-inactive"));
    pane1.classList.toggle('hidden', n!==1);
    pane2.classList.toggle('hidden', n!==2);
    pane3.classList.toggle('hidden', n!==3);
    errorBox.classList.add('hidden');
  }

  function showError(msg){
    errorBox.textContent = msg;
    errorBox.classList.remove('hidden');
  }

  // Bot√µes Step 1
  modeRobloxBtn.addEventListener('click', ()=>{ mode='roblox'; });
  modePlatformBtn.addEventListener('click', ()=>{ mode='platform'; });

  document.getElementById('to-step-2').addEventListener('click', ()=>{
    if(!mode){ showError("Escolha um modo antes de prosseguir."); return; }
    robloxPane.classList.toggle('hidden', mode!=='roblox');
    platformPane.classList.toggle('hidden', mode!=='platform');
    setStep(2);
  });

  document.getElementById('back-step-1').addEventListener('click', ()=> setStep(1));

  document.getElementById('to-step-3').addEventListener('click', ()=>{
    let summary = "";
    if(mode==='roblox'){
      const link = document.getElementById('roblox-link').value.trim();
      if(!link){ showError("Informe o link privado do Roblox."); return; }
      summary = `<strong>Modo:</strong> Roblox<br><strong>Link:</strong> ${link}`;
    }
    if(mode==='platform'){
      const p = platformSelect.value;
      const u = document.getElementById('platform-username').value.trim();
      const l = document.getElementById('platform-link').value.trim();
      if(!p || !u || !l){ showError("Preencha todos os campos da plataforma."); return; }
      summary = `<strong>Plataforma:</strong> ${p}<br><strong>Usu√°rio:</strong> ${u}<br><strong>Link:</strong> ${l}`;
    }
    document.getElementById('summary').innerHTML = summary;
    setStep(3);
  });

  document.getElementById('back-step-2').addEventListener('click', ()=> setStep(2));

  document.getElementById('reset-all').addEventListener('click', ()=>{
    mode = null;
    document.getElementById('roblox-link').value = "";
    document.getElementById('platform-username').value = "";
    document.getElementById('platform-link').value = "";
    setStep(1);
  });

  document.getElementById('start-generate').addEventListener('click', async ()=>{
    const payload = {};
    if(mode==='roblox'){
      payload.type="roblox";
      payload.link=document.getElementById('roblox-link').value.trim();
    } else {
      payload.type="platform";
      payload.platform=platformSelect.value;
      payload.username=document.getElementById('platform-username').value.trim();
      payload.link=document.getElementById('platform-link').value.trim();
    }

    try{
      const res = await fetch('/api/builder', {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) return showError(data.error||"Erro ao gerar builder.");

      const link = window.location.origin + data.link;
      document.getElementById('generated-output').value = link;
      document.getElementById('output-area').classList.remove('hidden');
      document.getElementById('copy-output').classList.remove('hidden');
    }catch(e){ showError("Erro de conex√£o."); }
  });

  document.getElementById('copy-output').addEventListener('click', async ()=>{
    const val = document.getElementById('generated-output').value;
    await navigator.clipboard.writeText(val);
    alert("Copiado!");
  });

  // Atualiza usos restantes
  async function refreshUser(){
    try {
      const r = await fetch('/api/user', { credentials: 'include' });
      const u = await r.json();
      usesLeftEl.textContent = u?.user?.usesLeft ?? '‚Äî';
    } catch(e){ usesLeftEl.textContent='‚Äî'; }
  }
  await refreshUser();

  setStep(1);
})();
</script>
</body>
</html>
