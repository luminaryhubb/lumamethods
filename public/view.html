<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luma Paste</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-950 text-white min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl bg-neutral-900 rounded-xl shadow-lg p-6 space-y-4">
    <h1 class="text-2xl font-bold text-purple-400">ğŸ”’ Paste Protegido</h1>
    <p class="text-neutral-400 text-sm">Insira a senha para visualizar o conteÃºdo.</p>

    <!-- FormulÃ¡rio de senha -->
    <div id="password-section" class="space-y-3">
      <input
        type="password"
        id="password-input"
        placeholder="Digite a senha"
        class="w-full p-2 rounded bg-neutral-800 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
      <button
        id="access-btn"
        class="w-full bg-purple-600 hover:bg-purple-700 rounded p-2 font-semibold"
      >
        Acessar
      </button>
    </div>

    <!-- ConteÃºdo do paste -->
    <div id="content-section" class="hidden space-y-3">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold">ConteÃºdo do Paste</h2>
        <span id="views" class="text-sm text-neutral-400"></span>
      </div>
      <pre
        id="paste-text"
        class="bg-neutral-800 p-4 rounded text-sm whitespace-pre-wrap overflow-x-auto"
      ></pre>

      <div class="flex justify-between items-center text-sm text-neutral-400">
        <span id="author"></span>
        <span id="created-at"></span>
      </div>

      <div id="redirect-section" class="hidden pt-2">
        <a
          id="redirect-link"
          href="#"
          target="_blank"
          class="text-purple-400 hover:underline"
        >
          ğŸ‘‰ Ir para link associado
        </a>
      </div>
    </div>

    <!-- Erro -->
    <div id="error" class="hidden text-red-400 font-semibold"></div>
  </div>

  <script>
    const pasteId = window.location.pathname.split("/").pop();
    const accessBtn = document.getElementById("access-btn");
    const passwordInput = document.getElementById("password-input");
    const errorDiv = document.getElementById("error");
    const contentSection = document.getElementById("content-section");
    const passwordSection = document.getElementById("password-section");
    const pasteText = document.getElementById("paste-text");
    const viewsSpan = document.getElementById("views");
    const authorSpan = document.getElementById("author");
    const createdAtSpan = document.getElementById("created-at");
    const redirectSection = document.getElementById("redirect-section");
    const redirectLink = document.getElementById("redirect-link");

    let pasteMeta = null;

    async function loadMeta() {
      try {
        const r = await fetch(`/api/paste/${pasteId}/data`);
        if (!r.ok) throw new Error("Falha ao carregar metadados");
        pasteMeta = await r.json();
      } catch (err) {
        errorDiv.textContent = "Erro: " + err.message;
        errorDiv.classList.remove("hidden");
      }
    }

    async function accessPaste() {
      errorDiv.classList.add("hidden");
      try {
        const r = await fetch(`/api/paste/${pasteId}/access`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: passwordInput.value }),
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "Senha incorreta");

        passwordSection.classList.add("hidden");
        contentSection.classList.remove("hidden");

        pasteText.textContent = data.text;
        viewsSpan.textContent = `${(pasteMeta.views || 0) + 1} views`;
        authorSpan.textContent = pasteMeta.createdByName
          ? `Autor: ${pasteMeta.createdByName}`
          : "";
        createdAtSpan.textContent = pasteMeta.createdAt
          ? `Criado em ${new Date(pasteMeta.createdAt).toLocaleString()}`
          : "";

        if (data.redirect) {
          redirectSection.classList.remove("hidden");
          redirectLink.href = data.redirect;
        }
      } catch (err) {
        errorDiv.textContent = "Erro: " + err.message;
        errorDiv.classList.remove("hidden");
      }
    }

    accessBtn.addEventListener("click", accessPaste);
    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") accessPaste();
    });

    loadMeta();
  </script>
</body>
</html>
